name: Backup to Mega Cloud
on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 */3 * *'
jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install MEGAcmd
        run: |
          wget -q https://mega.nz/linux/repo/xUbuntu_22.04/amd64/megacmd-xUbuntu_22.04_amd64.deb
          sudo apt-get install -y ./megacmd-xUbuntu_22.04_amd64.deb
      - name: Create and upload backup
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASSWORD: ${{ secrets.MEGA_PASSWORD }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          ARCHIVE_NAME="${REPO_NAME}_$(date +%Y%m%d_%H%M%S).tar.gz"
          tar -czf "/tmp/$ARCHIVE_NAME" --exclude=".git" . || true
          mega-login "$MEGA_EMAIL" "$MEGA_PASSWORD"
          mega-mkdir -p "/Backups/GitHub/${REPO_NAME}" || true
          mega-put "/tmp/$ARCHIVE_NAME" "/Backups/GitHub/${REPO_NAME}/"
          mega-logout
