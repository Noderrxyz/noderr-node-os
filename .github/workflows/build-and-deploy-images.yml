name: Build and Deploy NodeOS Images

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        default: 'latest'

env:
  R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
  R2_BUCKET: noderr-node-packages
  R2_PUBLIC_URL: https://pub-66ad852cb9e54582bd0af64bce8d0a04.r2.dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tier: [oracle, guardian, validator]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="$(date +%Y%m%d )-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build ${{ matrix.tier }} Docker image
        run: |
          cd docker/${{ matrix.tier }}
          docker build -t noderr-${{ matrix.tier }}:${{ steps.version.outputs.version }} -f Dockerfile .
          docker tag noderr-${{ matrix.tier }}:${{ steps.version.outputs.version }} noderr-${{ matrix.tier }}:latest

      - name: Test ${{ matrix.tier }} image
        run: |
          # Basic health check - verify image can start
          docker run --rm noderr-${{ matrix.tier }}:latest node --version

      - name: Export ${{ matrix.tier }} image
        run: |
          mkdir -p release-artifacts/${{ matrix.tier }}
          docker save noderr-${{ matrix.tier }}:${{ steps.version.outputs.version }} | gzip > release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz
          docker save noderr-${{ matrix.tier }}:latest | gzip > release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz
          
          # Generate checksums
          cd release-artifacts/${{ matrix.tier }}
          sha256sum ${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz > ${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz.sha256
          sha256sum ${{ matrix.tier }}-latest.tar.gz > ${{ matrix.tier }}-latest.tar.gz.sha256
          
          # Create metadata file
          cat > ${{ matrix.tier }}-metadata.json << EOF
          {
            "tier": "${{ matrix.tier }}",
            "version": "${{ steps.version.outputs.version }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "image_size": "$(stat -f%z ${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz 2>/dev/null || stat -c%s ${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz)"
          }
          EOF

      - name: Configure AWS credentials for R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto

      - name: Upload ${{ matrix.tier }} to R2
        run: |
          # Upload versioned image
          aws s3 cp \
            release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz \
            --endpoint-url ${{ env.R2_ENDPOINT }}
          
          # Upload latest image
          aws s3 cp \
            release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz \
            --endpoint-url ${{ env.R2_ENDPOINT }}
          
          # Upload checksums
          aws s3 cp \
            release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz.sha256 \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz.sha256 \
            --endpoint-url ${{ env.R2_ENDPOINT }}
          
          aws s3 cp \
            release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz.sha256 \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz.sha256 \
            --endpoint-url ${{ env.R2_ENDPOINT }}
          
          # Upload metadata
          aws s3 cp \
            release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-metadata.json \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-metadata.json \
            --endpoint-url ${{ env.R2_ENDPOINT }}
          
          echo "âœ… Uploaded ${{ matrix.tier }} image to R2"
          echo "ðŸ“¦ Download URL: ${{ env.R2_PUBLIC_URL }}/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.tier }}-images
          path: release-artifacts/${{ matrix.tier }}/
          retention-days: 30

  create-release:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: NodeOS ${{ github.ref_name }}
          body: |
            ## NodeOS Docker Images Release ${{ github.ref_name }}
            
            ### Download URLs (R2)
            - **Oracle**: `${{ env.R2_PUBLIC_URL }}/oracle/oracle-${{ github.ref_name }}.tar.gz`
            - **Guardian**: `${{ env.R2_PUBLIC_URL }}/guardian/guardian-${{ github.ref_name }}.tar.gz`
            - **Validator**: `${{ env.R2_PUBLIC_URL }}/validator/validator-${{ github.ref_name }}.tar.gz`
            
            ### Installation
            ```bash
            # Download and load Oracle node
            curl -O ${{ env.R2_PUBLIC_URL }}/oracle/oracle-latest.tar.gz
            docker load < oracle-latest.tar.gz
            
            # Download and load Guardian node
            curl -O ${{ env.R2_PUBLIC_URL }}/guardian/guardian-latest.tar.gz
            docker load < guardian-latest.tar.gz
            
            # Download and load Validator node
            curl -O ${{ env.R2_PUBLIC_URL }}/validator/validator-latest.tar.gz
            docker load < validator-latest.tar.gz
            ```
            
            ### Checksums
            SHA256 checksums are available at the same URLs with `.sha256` extension.
            
            See [RELEASE_NOTES.md](https://github.com/Noderrxyz/noderr-node-os/blob/master/RELEASE_NOTES.md ) for detailed changes.
          files: |
            release-artifacts/**/*.tar.gz
            release-artifacts/**/*.sha256
            release-artifacts/**/*.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Build summary
        run: |
          echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All NodeOS images have been built and deployed to R2." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Oracle: ${{ env.R2_PUBLIC_URL }}/oracle/oracle-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- Guardian: ${{ env.R2_PUBLIC_URL }}/guardian/guardian-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- Validator: ${{ env.R2_PUBLIC_URL }}/validator/validator-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
