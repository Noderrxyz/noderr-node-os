name: Build and Deploy NodeOS Images

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        default: 'latest'

env:
  R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
  R2_BUCKET: noderr-node-packages
  R2_PUBLIC_URL: https://pub-66ad852cb9e54582bd0af64bce8d0a04.r2.dev

jobs:
  # ============================================================================
  # Build Node.js tier images (oracle, guardian, validator )
  # ============================================================================
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tier: [oracle, guardian, validator]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build ${{ matrix.tier }} Docker image
        run: |
          docker build -t noderr-${{ matrix.tier }}:${{ steps.version.outputs.version }} -f docker/${{ matrix.tier }}/Dockerfile .
          docker tag noderr-${{ matrix.tier }}:${{ steps.version.outputs.version }} noderr-${{ matrix.tier }}:latest

      - name: Test ${{ matrix.tier }} image
        run: |
          echo "Testing ${{ matrix.tier }} image..."
          docker run --rm noderr-${{ matrix.tier }}:latest node --version
          docker run --rm noderr-${{ matrix.tier }}:latest pnpm --version

      - name: Export ${{ matrix.tier }} image
        run: |
          mkdir -p release-artifacts/${{ matrix.tier }}
          docker save noderr-${{ matrix.tier }}:${{ steps.version.outputs.version }} | gzip > release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz
          docker save noderr-${{ matrix.tier }}:latest | gzip > release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz

          cd release-artifacts/${{ matrix.tier }}
          sha256sum ${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz > ${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz.sha256
          sha256sum ${{ matrix.tier }}-latest.tar.gz > ${{ matrix.tier }}-latest.tar.gz.sha256

          cat > metadata.json << EOF
          {
            "tier": "${{ matrix.tier }}",
            "version": "${{ steps.version.outputs.version }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "repository": "${{ github.repository }}"
          }
          EOF

      - name: Upload ${{ matrix.tier }} to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          aws s3 cp release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz.sha256 \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-${{ steps.version.outputs.version }}.tar.gz.sha256 \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz.sha256 \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz.sha256 \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/${{ matrix.tier }}/metadata.json \
            s3://${{ env.R2_BUCKET }}/${{ matrix.tier }}/metadata.json \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          echo "âœ… Uploaded ${{ matrix.tier }} to R2"
          echo "ðŸ“¦ Download URL: ${{ env.R2_PUBLIC_URL }}/${{ matrix.tier }}/${{ matrix.tier }}-latest.tar.gz"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.tier }}-images
          path: release-artifacts/${{ matrix.tier }}/
          retention-days: 30

  # ============================================================================
  # Build ml-service (Python/PyTorch GPU inference container for Oracle nodes)
  # ============================================================================
  build-ml-service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building ml-service version: ${VERSION}"

      - name: Build ml-service Docker image
        run: |
          docker build \
            -t noderr-ml-service:${{ steps.version.outputs.version }} \
            -t noderr-ml-service:latest \
            -f ml-service/Dockerfile \
            ml-service/

      - name: Test ml-service image (CPU mode)
        run: |
          echo "Testing ml-service image..."
          docker run --rm noderr-ml-service:latest python --version
          docker run --rm noderr-ml-service:latest python -c "import torch; print(f'PyTorch {torch.__version__} loaded successfully')"
          docker run --rm noderr-ml-service:latest python -c "import grpc; print(f'gRPC {grpc.__version__} loaded successfully')"

      - name: Export ml-service image
        run: |
          mkdir -p release-artifacts/ml-service
          docker save noderr-ml-service:${{ steps.version.outputs.version }} | gzip > release-artifacts/ml-service/ml-service-${{ steps.version.outputs.version }}.tar.gz
          docker save noderr-ml-service:latest | gzip > release-artifacts/ml-service/ml-service-latest.tar.gz

          cd release-artifacts/ml-service
          sha256sum ml-service-${{ steps.version.outputs.version }}.tar.gz > ml-service-${{ steps.version.outputs.version }}.tar.gz.sha256
          sha256sum ml-service-latest.tar.gz > ml-service-latest.tar.gz.sha256

          cat > metadata.json << EOF
          {
            "tier": "ml-service",
            "version": "${{ steps.version.outputs.version }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "repository": "${{ github.repository }}",
            "base_image": "nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04",
            "pytorch_version": "2.9.1",
            "cuda_version": "12.1"
          }
          EOF

      - name: Upload ml-service to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          aws s3 cp release-artifacts/ml-service/ml-service-${{ steps.version.outputs.version }}.tar.gz \
            s3://${{ env.R2_BUCKET }}/ml-service/ml-service-${{ steps.version.outputs.version }}.tar.gz \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/ml-service/ml-service-latest.tar.gz \
            s3://${{ env.R2_BUCKET }}/ml-service/ml-service-latest.tar.gz \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/ml-service/ml-service-${{ steps.version.outputs.version }}.tar.gz.sha256 \
            s3://${{ env.R2_BUCKET }}/ml-service/ml-service-${{ steps.version.outputs.version }}.tar.gz.sha256 \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/ml-service/ml-service-latest.tar.gz.sha256 \
            s3://${{ env.R2_BUCKET }}/ml-service/ml-service-latest.tar.gz.sha256 \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          aws s3 cp release-artifacts/ml-service/metadata.json \
            s3://${{ env.R2_BUCKET }}/ml-service/metadata.json \
            --endpoint-url ${{ env.R2_ENDPOINT }}

          echo "âœ… Uploaded ml-service to R2"
          echo "ðŸ“¦ Download URL: ${{ env.R2_PUBLIC_URL }}/ml-service/ml-service-latest.tar.gz"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ml-service-images
          path: release-artifacts/ml-service/
          retention-days: 30

  create-release:
    needs: [build-and-deploy, build-ml-service]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: NodeOS ${{ github.ref_name }}
          body: |
            ## NodeOS Docker Images Release ${{ github.ref_name }}

            This release contains production-ready Docker images for all three NodeOS tiers,
            plus the ML Service container required by Oracle nodes.

            ### Download from R2 (Recommended)
            ```bash
            # Oracle Node (requires two containers)
            curl -O ${{ env.R2_PUBLIC_URL }}/oracle/oracle-latest.tar.gz
            curl -O ${{ env.R2_PUBLIC_URL }}/ml-service/ml-service-latest.tar.gz
            docker load < oracle-latest.tar.gz
            docker load < ml-service-latest.tar.gz

            # Guardian Node
            curl -O ${{ env.R2_PUBLIC_URL }}/guardian/guardian-latest.tar.gz
            docker load < guardian-latest.tar.gz

            # Validator Node
            curl -O ${{ env.R2_PUBLIC_URL }}/validator/validator-latest.tar.gz
            docker load < validator-latest.tar.gz
            ```

            ### Checksums
            SHA256 checksums are available at the same URLs with `.sha256` extension.
          files: |
            release-artifacts/**/*.tar.gz
            release-artifacts/**/*.sha256
            release-artifacts/**/*.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    needs: [build-and-deploy, build-ml-service]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Build summary
        run: |
          echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All NodeOS images have been built and deployed to R2." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Oracle: ${{ env.R2_PUBLIC_URL }}/oracle/oracle-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- ML Service: ${{ env.R2_PUBLIC_URL }}/ml-service/ml-service-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- Guardian: ${{ env.R2_PUBLIC_URL }}/guardian/guardian-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- Validator: ${{ env.R2_PUBLIC_URL }}/validator/validator-latest.tar.gz" >> $GITHUB_STEP_SUMMARY
