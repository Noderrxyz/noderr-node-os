name: Mirror to GitLab

on:
  push:
    branches:
      - '**'  # Mirror all branches
  delete:
    branches:
      - '**'  # Sync branch deletions

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper mirroring
          
      - name: Mirror to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          # Add random delay (0-10 seconds) to prevent simultaneous pushes across repos
          sleep $((RANDOM % 10))
          
          # Extract repository name
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          
          # Configure git
          git config --global user.name "GitHub Mirror Bot"
          git config --global user.email "bot@noderr.xyz"
          
          # Add GitLab remote with token authentication
          git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.com/Noderrxyz/${REPO_NAME}.git" || \
          git remote set-url gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.com/Noderrxyz/${REPO_NAME}.git"
          
          # Push with retry logic (3 attempts)
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "üîÑ Attempt $attempt of $MAX_RETRIES"
            
            # Push all branches
            if git push gitlab --all --force; then
              echo "‚úÖ Successfully pushed branches"
              BRANCHES_SUCCESS=true
            else
              echo "‚ö†Ô∏è  Failed to push branches"
              BRANCHES_SUCCESS=false
            fi
            
            # Push all tags
            if git push gitlab --tags --force; then
              echo "‚úÖ Successfully pushed tags"
              TAGS_SUCCESS=true
            else
              echo "‚ö†Ô∏è  Failed to push tags"
              TAGS_SUCCESS=false
            fi
            
            # Check if both succeeded
            if [ "$BRANCHES_SUCCESS" = true ] && [ "$TAGS_SUCCESS" = true ]; then
              echo "‚úÖ Successfully mirrored ${REPO_NAME} to GitLab"
              exit 0
            fi
            
            # If not last attempt, wait before retry
            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "‚è≥ Waiting ${RETRY_DELAY} seconds before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "‚ùå Failed to mirror after $MAX_RETRIES attempts"
          exit 1
