/**
 * Defense Types - Protection against manipulation and exploitation
 */

import { BigNumber } from 'bignumber.js';

export interface ThreatDetection {
  id: string;
  type: ThreatType;
  severity: ThreatSeverity;
  source: string;
  target: string;
  confidence: number;
  timestamp: number;
  indicators: ThreatIndicator[];
  suggestedAction: DefensiveAction;
  metadata?: Record<string, any>;
}

export enum ThreatType {
  MANIPULATION = 'manipulation',
  WASH_TRADING = 'wash_trading',
  SPOOFING = 'spoofing',
  LAYERING = 'layering',
  PUMP_DUMP = 'pump_dump',
  FRONT_RUNNING = 'front_running',
  API_ABUSE = 'api_abuse',
  DDOS = 'ddos'
}

export enum ThreatSeverity {
  LOW = 'low',
  MEDIUM = 'medium',
  HIGH = 'high',
  CRITICAL = 'critical'
}

export interface ThreatIndicator {
  type: string;
  value: any;
  confidence: number;
  timestamp: number;
}

export interface DefensiveAction {
  type: DefenseActionType;
  parameters: Record<string, any>;
  urgency: 'immediate' | 'high' | 'normal' | 'low';
  expectedOutcome: string;
}

export enum DefenseActionType {
  EMERGENCY_STOP = 'emergency_stop',
  REDUCE_EXPOSURE = 'reduce_exposure',
  CANCEL_ORDERS = 'cancel_orders',
  SWITCH_VENUE = 'switch_venue',
  ENABLE_PROTECTION = 'enable_protection',
  ADJUST_SPREADS = 'adjust_spreads',
  DELAY_EXECUTION = 'delay_execution',
  ALERT_ONLY = 'alert_only'
}

export interface MarketManipulation {
  type: ManipulationType;
  venue: string;
  symbol: string;
  detected: number; // timestamp
  confidence: number;
  evidence: ManipulationEvidence[];
  estimatedImpact: {
    priceImpact: number; // basis points
    volumeImpact: BigNumber;
    affectedOrders: number;
  };
  actors?: string[]; // addresses or identifiers
}

export enum ManipulationType {
  WASH_TRADING = 'wash_trading',
  SPOOFING = 'spoofing',
  LAYERING = 'layering',
  PUMP_AND_DUMP = 'pump_and_dump',
  MOMENTUM_IGNITION = 'momentum_ignition',
  QUOTE_STUFFING = 'quote_stuffing',
  FRONT_RUNNING = 'front_running'
}

export interface ManipulationEvidence {
  type: string;
  timestamp: number;
  data: any;
  confidence: number;
}

export interface AntiManipulationConfig {
  enabled: boolean;
  sensitivity: number; // 0-1
  detectionMethods: DetectionMethod[];
  responses: {
    [key in ThreatType]?: DefenseActionType[];
  };
  whitelist: string[]; // trusted venues/addresses
  blacklist: string[]; // known bad actors
}

export interface DetectionMethod {
  name: string;
  enabled: boolean;
  parameters: Record<string, any>;
  weight: number; // importance in ensemble
}

export interface ProtectionStatus {
  active: boolean;
  level: 'minimal' | 'standard' | 'enhanced' | 'maximum';
  activeMeasures: ActiveProtection[];
  recentThreats: ThreatDetection[];
  performance: {
    threatsDetected: number;
    attacksPrevented: number;
    falsePositives: number;
    avgResponseTime: number; // milliseconds
  };
}

export interface ActiveProtection {
  type: ProtectionType;
  enabled: boolean;
  effectiveness: number; // 0-1
  cost: number; // basis points
  parameters: Record<string, any>;
}

export enum ProtectionType {
  MEV_PROTECTION = 'mev_protection',
  ORDER_RANDOMIZATION = 'order_randomization',
  SPLIT_ROUTING = 'split_routing',
  EXECUTION_DELAY = 'execution_delay',
  QUOTE_PROTECTION = 'quote_protection',
  ANTI_GAMING = 'anti_gaming'
} 