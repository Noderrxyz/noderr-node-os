/**
 * Microstructure Types - Deep market microstructure analysis
 */

import { BigNumber } from 'bignumber.js';

export interface MicrostructureSignal {
  venue: string;
  symbol: string;
  timestamp: number;
  type: MicrostructureSignalType;
  strength: number; // -1 to 1
  confidence: number; // 0 to 1
  metadata: Record<string, any>;
}

export enum MicrostructureSignalType {
  ORDER_IMBALANCE = 'order_imbalance',
  TOXIC_FLOW = 'toxic_flow',
  HIDDEN_LIQUIDITY = 'hidden_liquidity',
  MOMENTUM_IGNITION = 'momentum_ignition',
  INVENTORY_PRESSURE = 'inventory_pressure',
  PRICE_DISCOVERY = 'price_discovery'
}

export interface OrderFlowAnalysis {
  venue: string;
  symbol: string;
  period: number; // milliseconds
  metrics: {
    buyPressure: number;
    sellPressure: number;
    largeOrderRatio: number;
    oddLotRatio: number;
    sweepRatio: number;
  };
  classification: Record<string, number>; // retail, institutional, algo, hft
  toxicity: {
    score: number;
    components: {
      adverseSelection: number;
      inventoryRisk: number;
      informationAsymmetry: number;
    };
  };
}

export interface SpreadDynamics {
  absolute: number;
  relative: number; // basis points
  trend: 'widening' | 'narrowing' | 'stable';
}

export interface MarketDepthProfile {
  venue: string;
  symbol: string;
  timestamp: number;
  levels: number;
  profile: {
    totalBidVolume: BigNumber;
    totalAskVolume: BigNumber;
    imbalanceRatio: number;
    volumeDistribution: VolumeDistribution;
    priceElasticity: number;
  };
  dynamics: {
    replenishmentRate: number;
    decayRate: number;
    shiftVelocity: number;
  };
}

export interface VolumeDistribution {
  percentiles: {
    p10: number;
    p25: number;
    p50: number;
    p75: number;
    p90: number;
  };
  skewness: number;
  kurtosis: number;
  gini: number; // concentration coefficient
}

export interface TickAnalysis {
  venue: string;
  symbol: string;
  timestamp: number;
  window: number; // milliseconds
  metrics: {
    tickSize: number;
    ticksPerSecond: number;
    uptickRatio: number;
    largeTickRatio: number;
    tickClustering: number; // 0-1
  };
  patterns: {
    momentum: boolean;
    reversal: boolean;
    accumulation: boolean;
    distribution: boolean;
  };
}

export interface HiddenLiquidity {
  venue: string;
  symbol: string;
  detected: boolean;
  confidence: number;
  estimatedSize: BigNumber;
  priceLevel: number;
  type: 'iceberg' | 'reserve' | 'dark_pool';
  behavior: {
    refillRate: number;
    triggerSize: BigNumber;
    participation: number;
  };
}

export interface MarketImpactModel {
  venue: string;
  symbol: string;
  temporary: {
    linear: number;
    squareRoot: number;
    parameters: {
      lambda: number;
      eta: number;
      gamma: number;
    };
  };
  permanent: {
    linear: number;
    concave: number;
    parameters: {
      alpha: number;
      beta: number;
    };
  };
  decay: {
    halfLife: number; // milliseconds
    shape: 'exponential' | 'power_law';
  };
}

export interface MarketMicrostructure {
  venue: string;
  symbol: string;
  timestamp: number;
  spread: SpreadDynamics;
  depth: {
    levels: number;
    imbalance: number;
    resilience: number;
  };
  orderFlow: {
    buyVolume: BigNumber;
    sellVolume: BigNumber;
    netFlow: BigNumber;
    vwap: number;
    toxicity: number;
  };
  liquidity: {
    available: BigNumber;
    resilience: number;
    replenishmentRate: number;
  };
} 